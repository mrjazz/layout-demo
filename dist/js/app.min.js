const state={canvasWidth:500,canvasHeight:500,elements:[],activeElementId:null,nextId:1,resizeMode:!1,resizeHandle:null,resizeStartClientX:0,resizeStartClientY:0,resizeStartWidth:0,resizeStartHeight:0},canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),HANDLE_SIZE=10,MIN_DIM=20;function elementColor(t){return`hsl(${137*t%360}, 65%, 55%)`}function toCanvasCoords(t,e){const n=canvas.getBoundingClientRect();return{x:(t-n.left)*(canvas.width/n.width),y:(e-n.top)*(canvas.height/n.height)}}function getElementAt(t,e){const{x:n,y:a}=toCanvasCoords(t,e);for(let t=state.elements.length-1;t>=0;t--){const e=state.elements[t];if(e.placed&&(n>=e.x&&n<=e.x+e.width&&a>=e.y&&a<=e.y+e.height))return e}return null}function getResizeHandle(t,e,n){const{x:a,y:i}=toCanvasCoords(e,n),s=t.x+t.width,d=t.y+t.height,c=a>=s-10&&a<=s+10&&i>=d-10&&i<=d+10,l=a>=s-10&&a<=s+10&&i>=t.y&&i<=d,r=i>=d-10&&i<=d+10&&a>=t.x&&a<=s;return c?"corner":l?"right":r?"bottom":null}function renderElementsList(){const t=document.getElementById("elementsList");0!==state.elements.length?(t.innerHTML=state.elements.map(t=>`\n    <div class="element-item ${t.id===state.activeElementId?"active":""}" data-id="${t.id}">\n      <span class="el-num">${t.id}</span>\n      <div class="swatch" style="background: ${t.color}"></div>\n      <div class="dims">\n        <input type="number" data-id="${t.id}" data-dim="w" value="${t.width}" min="20">\n        <span>×</span>\n        <input type="number" data-id="${t.id}" data-dim="h" value="${t.height}" min="20">\n      </div>\n      <button class="btn-remove-item" data-id="${t.id}">Remove</button>\n    </div>\n  `).join(""),t.querySelectorAll(".element-item").forEach(t=>{t.addEventListener("click",e=>{e.target.classList.contains("btn-remove-item")||"INPUT"===e.target.tagName||(state.activeElementId=parseInt(t.dataset.id,10),renderElementsList(),render())})}),t.querySelectorAll(".btn-remove-item").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const n=parseInt(t.dataset.id,10);state.elements=state.elements.filter(t=>t.id!==n),state.activeElementId===n&&(state.activeElementId=null),renderElementsList(),render(),updateStatus("Element removed.")})}),t.querySelectorAll(".dims input").forEach(t=>{t.addEventListener("change",e=>{const n=parseInt(t.dataset.id,10),a=t.dataset.dim,i=state.elements.find(t=>t.id===n);if(!i)return;const s=Math.max(20,parseInt(t.value,10)||20);i["w"===a?"width":"height"]=s,t.value=s,render()})})):t.innerHTML='<div class="empty-elements">No elements. Click + Add to create one.</div>'}function updateCanvasSize(){const t=state.elements.filter(t=>t.placed);if(0===t.length)canvas.width=state.canvasWidth,canvas.height=state.canvasHeight;else{let e=0,n=0;for(const a of t)e=Math.max(e,a.x+a.width),n=Math.max(n,a.y+a.height);canvas.width=Math.max(state.canvasWidth,e),canvas.height=Math.max(state.canvasHeight,n)}canvas.style.width=canvas.width+"px",canvas.style.height=canvas.height+"px"}function render(){updateCanvasSize(),ctx.clearRect(0,0,canvas.width,canvas.height),(canvas.width>state.canvasWidth||canvas.height>state.canvasHeight)&&(ctx.setLineDash([6,4]),ctx.strokeStyle="#64748b",ctx.lineWidth=1,ctx.strokeRect(0,0,state.canvasWidth,state.canvasHeight),ctx.setLineDash([])),ctx.strokeStyle="#334155",ctx.lineWidth=1,ctx.strokeRect(0,0,canvas.width,canvas.height);for(const t of state.elements){if(!t.placed)continue;const e=t.id===state.activeElementId;ctx.fillStyle=t.color,ctx.fillRect(t.x,t.y,t.width,t.height),ctx.font="bold 14px system-ui, sans-serif",ctx.textAlign="center",ctx.textBaseline="middle";const n=t.x+t.width/2,a=t.y+t.height/2;if(ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.lineWidth=2,ctx.strokeText(String(t.id),n,a),ctx.fillStyle="#fff",ctx.fillText(String(t.id),n,a),ctx.strokeStyle=e?"#60a5fa":"#64748b",ctx.lineWidth=e?3:1,ctx.strokeRect(t.x,t.y,t.width,t.height),e){ctx.fillStyle="rgba(255,255,255,0.8)",ctx.strokeStyle="#60a5fa";const e=10;ctx.fillRect(t.x+t.width-e,t.y+t.height-e,e,e),ctx.strokeRect(t.x+t.width-e,t.y+t.height-e,e,e),ctx.fillRect(t.x+t.width-e,t.y+(t.height-e)/2,e,e),ctx.strokeRect(t.x+t.width-e,t.y+(t.height-e)/2,e,e),ctx.fillRect(t.x+(t.width-e)/2,t.y+t.height-e,e,e),ctx.strokeRect(t.x+(t.width-e)/2,t.y+t.height-e,e,e)}}}function updateStatus(t){document.getElementById("status").textContent=t}function addElement(){const t={id:state.nextId++,width:50,height:50,color:"",placed:!1,x:0,y:0};t.color=elementColor(t.id),state.elements.push(t),state.activeElementId=t.id,renderElementsList(),render(),updateStatus(`Added element ${t.id}. Set width/height, then Optimize.`)}function optimize(){if(0===state.elements.length)return void updateStatus("No elements to optimize.");const t=[...state.elements].sort((t,e)=>e.width*e.height-t.width*t.height),e=[];let n=!1;function a(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}for(const i of t){const t=i.width,s=i.height,d=[0],c=[0];for(const t of e)d.push(t.x+t.width),c.push(t.y+t.height);let l=-1,r=-1;for(const n of d)for(const i of c){if(n+t>state.canvasWidth||i+s>state.canvasHeight)continue;const d={x:n,y:i,width:t,height:s};let c=!1;for(const t of e)if(a(d,t)){c=!0;break}c||(l<0||i<r||i===r&&n<l)&&(l=n,r=i)}if(l<0){l=0,r=e.length?Math.max(...e.map(t=>t.y+t.height)):0,n=!0}i.x=l,i.y=r,i.placed=!0,e.push({x:i.x,y:i.y,width:i.width,height:i.height})}render(),updateStatus(n?"Optimized. Warning: some elements extend below canvas.":"Optimized layout (bottom-left, minimal gaps).")}canvas.addEventListener("mousedown",t=>{const e=getElementAt(t.clientX,t.clientY);if(!e)return state.activeElementId=null,renderElementsList(),void render();const n=getResizeHandle(e,t.clientX,t.clientY);n&&e.id===state.activeElementId?(state.resizeMode=!0,state.resizeHandle=n,state.resizeStartClientX=t.clientX,state.resizeStartClientY=t.clientY,state.resizeStartWidth=e.width,state.resizeStartHeight=e.height):(state.activeElementId=e.id,renderElementsList(),render(),updateStatus(`Selected element ${e.id} (${e.width}×${e.height}). Drag corner to resize.`))}),window.addEventListener("mousemove",t=>{if(!state.resizeMode||!state.activeElementId)return;const e=state.elements.find(t=>t.id===state.activeElementId);if(!e)return;const n=toCanvasCoords(state.resizeStartClientX,state.resizeStartClientY),a=toCanvasCoords(t.clientX,t.clientY),i=Math.round(a.x-n.x),s=Math.round(a.y-n.y);"corner"===state.resizeHandle?(e.width=Math.max(20,state.resizeStartWidth+i),e.height=Math.max(20,state.resizeStartHeight+s)):"right"===state.resizeHandle?e.width=Math.max(20,state.resizeStartWidth+i):"bottom"===state.resizeHandle&&(e.height=Math.max(20,state.resizeStartHeight+s)),render()}),window.addEventListener("mouseup",()=>{state.resizeMode&&renderElementsList(),state.resizeMode=!1,state.resizeHandle=null}),document.getElementById("btnAdd").addEventListener("click",addElement),document.getElementById("btnOptimize").addEventListener("click",optimize),document.getElementById("btnApply").addEventListener("click",()=>{const t=Math.max(100,parseInt(document.getElementById("configWidth").value,10)||500),e=Math.max(100,parseInt(document.getElementById("configHeight").value,10)||500);state.canvasWidth=t,state.canvasHeight=e,canvas.width=t,canvas.height=e,canvas.style.width=t+"px",canvas.style.height=e+"px",render(),updateStatus(`Canvas resized to ${t}×${e}.`)}),renderElementsList(),render();